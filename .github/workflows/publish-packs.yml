name: Publish QALITA Packs
on:
  push:
    branches:
      - main

# Minimal permissions following least privilege principle
permissions:
  contents: read
  actions: read

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: cloud-platform
    defaults:
      run:
        shell: bash
        working-directory: ./
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install QALITA CLI
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          pip install qalita

      - name: Configure QALITA environment
        env:
          QALITA_ENV_FILE: ${{ secrets.QALITA_ENV_FILE }}
        run: |
          mkdir -p ~/.qalita
          if [ -z "${QALITA_ENV_FILE:-}" ]; then
            echo "Missing secret QALITA_ENV_FILE" >&2
            exit 1
          fi
          printf '%s' "$QALITA_ENV_FILE" > ~/.qalita/.env-armand.leopold
          chmod 600 ~/.qalita/.env-armand.leopold

      - name: Login and push all packs
        working-directory: ./
        run: |
          set -euo pipefail
          source .venv/bin/activate
          qalita agent -n armand.leopold login
          shopt -s nullglob
          for dir in */ ; do
            [ -d "$dir" ] || continue
            if [ -f "$dir/pack_conf.json" ]; then
              pack_name="${dir%/}"
              echo "Pushing pack: $pack_name"
              qalita pack push -n "$pack_name"
            fi
          done